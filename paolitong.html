<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>票理通 - 发票管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 16px;
            max-width: 750px;
            margin: 0 auto;
            -webkit-tap-highlight-color: transparent;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: white;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            flex-wrap: wrap;
            gap: 12px;
        }
        .header-title h2 {
            margin-bottom: 4px;
            color: #1a1a1a;
            font-size: 24px;
        }
        .header-title p {
            color: #666;
            font-size: 14px;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        .import-btn {
            flex: 1;
            background-color: #1677ff;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
        }
        .test-btn {
            flex-shrink: 0;
            background-color: #52c41a;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        .settings-btn {
            flex-shrink: 0;
            background-color: #8c8c8c;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        .import-btn:active { background-color: #0d60d8; }
        .test-btn:active { background-color: #389e0d; }
        .settings-btn:active { background-color: #666; }
        .import-btn:disabled { background-color: #94bfff; cursor: not-allowed; }
        
        .invoice-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .invoice-item {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: all 0.2s ease;
        }
        .invoice-item.used { opacity: 0.6; }
        .invoice-item.used .invoice-amount { color: #999 !important; }
        .invoice-checkbox {
            width: 20px;
            height: 20px;
            margin-top: 4px;
            flex-shrink: 0;
            cursor: pointer;
            accent-color: #1677ff;
        }
        .invoice-info { flex: 1; min-width: 0; }
        .invoice-date { color: #999; font-size: 14px; margin-bottom: 6px; }
        .invoice-buyer { color: #333; font-size: 15px; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .invoice-amount { font-size: 22px; font-weight: bold; color: #d4380d; margin-bottom: 8px; }
        .invoice-meta { display: flex; flex-wrap: wrap; gap: 12px; color: #666; font-size: 13px; }
        .invoice-tag { background-color: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .invoice-item.used .invoice-tag { background-color: #e6f7ff; color: #1677ff; }
        
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }
        .action-btn {
            padding: 12px 6px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            background-color: white;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
        }
        .action-btn:active { background-color: #f5f5f5; }
        .action-btn.danger { border-color: #ff4d4f; color: #ff4d4f; }
        .action-btn.danger:active { background-color: #fff1f0; }
        
        .status { font-size: 13px; color: #999; margin-top: 6px; text-align: center; line-height: 1.5; }
        
        /* 模态框通用样式 */
        .modal-mask {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-mask.show { display: flex; }
        .modal-box {
            background-color: white;
            border-radius: 12px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title { font-size: 18px; font-weight: bold; color: #1a1a1a; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; color: #333; margin-bottom: 6px; }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus { border-color: #1677ff; }
        .form-tips { font-size: 12px; color: #999; margin-top: 4px; line-height: 1.4; }
        .modal-footer { display: flex; gap: 10px; margin-top: 24px; }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            font-weight: 500;
        }
        .modal-btn.cancel { background-color: #f5f5f5; color: #333; }
        .modal-btn.confirm { background-color: #1677ff; color: white; }
        .modal-btn.cancel:active { background-color: #e8e8e8; }
        .modal-btn.confirm:active { background-color: #0d60d8; }

        .loading-mask { z-index: 1000; }
        .loading-box { background-color: white; border-radius: 12px; padding: 24px 32px; text-align: center; min-width: 200px; }
        .loading-text { margin-top: 12px; font-size: 15px; color: #333; }
        #file-input { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <h2>票理通</h2>
            <p id="quota-text">导入额度：0/30</p>
        </div>
        <div class="btn-group">
            <button class="settings-btn" id="settings-btn">设置</button>
            <button class="test-btn" id="test-btn">测试接口</button>
            <button class="import-btn" id="import-btn">批量导入</button>
        </div>
        <input type="file" id="file-input" accept="image/jpg,image/jpeg,image/png" multiple>
    </div>
    
    <div class="invoice-list" id="invoice-list">
        <div style="text-align: center; padding: 60px 0; color: #999;">
            暂无发票数据，点击右上角「批量导入」添加发票
        </div>
    </div>
    
    <div class="actions">
        <button class="action-btn" id="select-all-btn">全选</button>
        <button class="action-btn danger" id="delete-btn">删除</button>
        <button class="action-btn" id="mark-used-btn">标记已用</button>
        <button class="action-btn" id="export-btn">导出备份</button>
    </div>
    
    <p class="status">您的发票数据仅保存在本设备本地，换手机或清除浏览器数据将丢失。</p>
    <p class="status">本工具仅供个人整理发票使用，不作为财务记账依据。</p>

    <!-- 设置模态框 -->
    <div class="modal-mask" id="settings-modal">
        <div class="modal-box">
            <div class="modal-title">API 密钥设置</div>
            <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="text" class="form-input" id="api-key-input" placeholder="请输入百度 API Key">
            </div>
            <div class="form-group">
                <label class="form-label">Secret Key</label>
                <input type="text" class="form-input" id="secret-key-input" placeholder="请输入百度 Secret Key">
            </div>
            <div class="form-tips">
                密钥仅保存在您当前浏览器本地，不会上传到任何服务器。<br>
                获取方式：百度智能云 → 文字识别 → 增值税发票识别 → 创建应用
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" id="close-settings-btn">取消</button>
                <button class="modal-btn confirm" id="save-settings-btn">保存</button>
            </div>
        </div>
    </div>

    <!-- Loading 遮罩 -->
    <div class="loading-mask" id="loading-mask">
        <div class="loading-box">
            <div class="loading-text" id="loading-text">正在识别发票内容...</div>
        </div>
    </div>

    <script>
        // ================= 核心修改1：新增CORS代理地址 =================
        const CORS_PROXY = 'https://corsproxy.io/?';
        // ================= 核心修改结束 =================

        const TOKEN_CACHE_KEY = 'baidu_ocr_token_cache';
        const KEYS_STORAGE_KEY = 'piaolitong_api_keys';
        const REQUEST_TIMEOUT = 10000;
        
        // 全局配置
        const MAX_QUOTA = 30;
        const STORAGE_KEY = 'piaolitong_invoice_data';
        let invoiceList = [];
        let accessToken = null;

        // DOM元素
        const importBtn = document.getElementById('import-btn');
        const testBtn = document.getElementById('test-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const fileInput = document.getElementById('file-input');
        const invoiceListDom = document.getElementById('invoice-list');
        const quotaText = document.getElementById('quota-text');
        const selectAllBtn = document.getElementById('select-all-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const markUsedBtn = document.getElementById('mark-used-btn');
        const exportBtn = document.getElementById('export-btn');
        const loadingMask = document.getElementById('loading-mask');
        const loadingText = document.getElementById('loading-text');
        
        // 设置模态框元素
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const secretKeyInput = document.getElementById('secret-key-input');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');

        // 页面初始化
        init();

        function init() {
            const localData = localStorage.getItem(STORAGE_KEY);
            if (localData) invoiceList = JSON.parse(localData);
            renderInvoiceList();
            updateQuota();
            bindEvents();
        }

        // 获取本地存储的密钥
        function getApiKeys() {
            const keysStr = localStorage.getItem(KEYS_STORAGE_KEY);
            if (!keysStr) return null;
            try {
                return JSON.parse(keysStr);
            } catch {
                return null;
            }
        }

        // 保存密钥到本地
        function saveApiKeys(apiKey, secretKey) {
            localStorage.setItem(KEYS_STORAGE_KEY, JSON.stringify({
                apiKey: apiKey.trim(),
                secretKey: secretKey.trim()
            }));
            localStorage.removeItem(TOKEN_CACHE_KEY);
            accessToken = null;
        }

        // 绑定所有按钮事件
        function bindEvents() {
            settingsBtn.addEventListener('click', openSettingsModal);
            closeSettingsBtn.addEventListener('click', closeSettingsModal);
            saveSettingsBtn.addEventListener('click', handleSaveSettings);
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeSettingsModal();
            });

            testBtn.addEventListener('click', testApiConnection);
            
            importBtn.addEventListener('click', async () => {
                const keys = getApiKeys();
                if (!keys || !keys.apiKey || !keys.secretKey) {
                    alert('请先点击「设置」按钮填入百度 API 密钥');
                    openSettingsModal();
                    return;
                }

                if (invoiceList.length >= MAX_QUOTA) {
                    alert('导入额度已用完，最多可导入30张发票');
                    return;
                }
                
                if (!accessToken) {
                    showLoading('正在初始化识别服务...');
                    try {
                        await initBaiduToken();
                        hideLoading();
                        alert('识别服务初始化成功，可以正常导入发票');
                    } catch (err) {
                        hideLoading();
                        alert(`识别服务初始化失败：${err.message}\n请先点击「测试接口」按钮排查问题`);
                        return;
                    }
                }
                fileInput.click();
            });
            
            fileInput.addEventListener('change', handleFileSelect);
            selectAllBtn.addEventListener('click', handleSelectAll);
            deleteBtn.addEventListener('click', handleDelete);
            markUsedBtn.addEventListener('click', handleMarkUsed);
            exportBtn.addEventListener('click', handleExport);
        }

        // 打开设置模态框
        function openSettingsModal() {
            const keys = getApiKeys();
            if (keys) {
                apiKeyInput.value = keys.apiKey || '';
                secretKeyInput.value = keys.secretKey || '';
            } else {
                apiKeyInput.value = '';
                secretKeyInput.value = '';
            }
            settingsModal.classList.add('show');
        }

        // 关闭设置模态框
        function closeSettingsModal() {
            settingsModal.classList.remove('show');
        }

        // 保存设置
        function handleSaveSettings() {
            const apiKey = apiKeyInput.value;
            const secretKey = secretKeyInput.value;
            
            if (!apiKey.trim() || !secretKey.trim()) {
                alert('请填写完整的 API Key 和 Secret Key');
                return;
            }
            
            saveApiKeys(apiKey, secretKey);
            closeSettingsModal();
            alert('密钥保存成功！可以开始使用了');
        }

        // 接口连通性测试
        async function testApiConnection() {
            const keys = getApiKeys();
            if (!keys || !keys.apiKey || !keys.secretKey) {
                alert('请先点击「设置」按钮填入百度 API 密钥');
                openSettingsModal();
                return;
            }

            showLoading('正在测试接口连通性...');
            try {
                await initBaiduToken();
                hideLoading();
                alert('✅ 接口测试成功！识别服务正常，可以正常导入发票');
            } catch (err) {
                hideLoading();
                alert(`❌ 接口测试失败\n失败原因：${err.message}\n\n解决建议：\n1. 检查密钥是否填写正确\n2. 用手机自带浏览器打开本地html文件，不要用在线预览页\n3. 检查百度控制台是否已开通「增值税发票识别」接口并领取免费额度\n4. 检查账号是否已完成实名认证\n5. 检查手机网络是否正常`);
            }
        }

        // 百度OCR Token初始化
        async function initBaiduToken() {
            const cache = localStorage.getItem(TOKEN_CACHE_KEY);
            if (cache) {
                const { token, expireTime } = JSON.parse(cache);
                if (Date.now() < expireTime) {
                    accessToken = token;
                    return;
                }
            }

            const keys = getApiKeys();
            if (!keys || !keys.apiKey || !keys.secretKey) {
                throw new Error('未找到 API 密钥，请先在设置中填写');
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
            try {
                // ================= 核心修改2：Token请求通过CORS代理 =================
                const res = await fetch(`${CORS_PROXY}https://aip.baidubce.com/oauth/2.0/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `grant_type=client_credentials&client_id=${keys.apiKey}&client_secret=${keys.secretKey}`,
                    signal: controller.signal
                });
                // ================= 核心修改结束 =================

                clearTimeout(timeoutId);
                const data = await res.json();
                
                if (data.error) {
                    const errorMap = {
                        'invalid_client': 'API Key或Secret Key错误，请检查密钥是否正确',
                        'unauthorized_client': '密钥无效或应用未创建成功',
                        'invalid_grant': '授权类型错误',
                        'unsupported_grant_type': '授权类型不支持'
                    };
                    throw new Error(errorMap[data.error] || data.error_description);
                }
                
                accessToken = data.access_token;
                localStorage.setItem(TOKEN_CACHE_KEY, JSON.stringify({
                    token: accessToken,
                    expireTime: Date.now() + (data.expires_in - 86400) * 1000
                }));
            } catch (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                    throw new Error('请求超时，请检查网络后重试');
                } else if (err.message.includes('Failed to fetch')) {
                    throw new Error('跨域请求被浏览器拦截，请用系统浏览器打开本地html文件，不要用在线预览页');
                } else {
                    throw err;
                }
            }
        }

        // 处理文件选择与批量识别
        async function handleFileSelect(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            const remainingQuota = MAX_QUOTA - invoiceList.length;
            if (files.length > remainingQuota) {
                alert(`剩余额度仅${remainingQuota}张，无法导入${files.length}张发票`);
                fileInput.value = '';
                return;
            }
            
            showLoading(`正在准备识别第1/${files.length}张发票...`);
            let successCount = 0;
            let failCount = 0;
            let failReason = '';
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    loadingText.innerText = `正在识别第${i+1}/${files.length}张发票...`;
                    
                    try {
                        const invoiceInfo = await recognizeInvoice(file);
                        if (invoiceInfo) {
                            invoiceInfo.id = Date.now() + Math.random().toString(36).substr(2, 9);
                            invoiceInfo.checked = false;
                            invoiceInfo.used = false;
                            invoiceList.unshift(invoiceInfo);
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (err) {
                        failCount++;
                        failReason = err.message;
                        console.error(`第${i+1}张识别失败`, err);
                    }
                }
                
                saveToLocal();
                renderInvoiceList();
                updateQuota();
                
                if (failCount > 0) {
                    alert(`导入完成：成功${successCount}张，失败${failCount}张\n失败原因：${failReason || '发票图片不清晰或非增值税发票'}`);
                } else {
                    alert(`导入完成：成功${successCount}张发票`);
                }
            } catch (error) {
                console.error('批量识别失败', error);
                alert(`批量导入失败：${error.message}`);
            } finally {
                hideLoading();
                fileInput.value = '';
            }
        }

        // 发票识别核心函数
        async function recognizeInvoice(file) {
            if (!file.type.startsWith('image/')) {
                throw new Error('仅支持JPG、PNG格式的图片');
            }
            
            const base64 = await compressImage(file);
            const base64Data = base64.split(',')[1];
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
            
            try {
                // ================= 核心修改3：OCR识别请求通过CORS代理 =================
                const res = await fetch(`${CORS_PROXY}https://aip.baidubce.com/rest/2.0/ocr/v1/vat_invoice?access_token=${accessToken}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `image=${encodeURIComponent(base64Data)}`,
                    signal: controller.signal
                });
                // ================= 核心修改结束 =================

                clearTimeout(timeoutId);
                const data = await res.json();
                
                if (data.error_code) {
                    const errorMap = {
                        100: 'API Key错误，请检查密钥是否正确',
                        110: 'Token无效，请刷新页面重试',
                        111: 'Token已过期，请刷新页面重试',
                        216100: '未开通增值税发票识别接口，请去百度控制台开通免费额度',
                        216101: '账号未完成实名认证，无法调用接口',
                        216102: '接口调用次数超限，请检查免费额度是否用完',
                        216103: '接口配置错误，请检查应用是否已开通该接口权限',
                        282000: '图片格式错误，仅支持JPG、PNG格式',
                        282003: '图片尺寸过大，已自动压缩，请重试',
                        282100: '未识别到增值税发票，请确保图片是清晰的发票'
                    };
                    throw new Error(errorMap[data.error_code] || data.error_msg);
                }
                
                if (data.words_result && data.words_result.VatInvoiceInfos) {
                    const info = data.words_result.VatInvoiceInfos;
                    const buyerName = info.find(item => item.key.includes('购买方名称'))?.value || '未识别到购买方';
                    const invoiceDate = info.find(item => item.key.includes('开票日期'))?.value || '未识别到日期';
                    const amount = info.find(item => item.key.includes('价税合计'))?.value || '0.00';
                    const invoiceNo = info.find(item => item.key.includes('发票号码'))?.value || '未识别到编号';
                    const formatAmount = amount.replace(/[¥￥,]/g, '').trim();
                    
                    return { buyerName, invoiceDate, amount: formatAmount, invoiceNo };
                } else {
                    throw new Error('未识别到有效发票信息');
                }
            } catch (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                    throw new Error('识别请求超时，请检查网络后重试');
                } else {
                    throw err;
                }
            }
        }

        // 图片压缩工具函数
        function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    img.onerror = () => reject(new Error('图片加载失败'));
                };
                reader.onerror = () => reject(new Error('文件读取失败'));
            });
        }

        // 渲染发票列表
        function renderInvoiceList() {
            if (invoiceList.length === 0) {
                invoiceListDom.innerHTML = `
                    <div style="text-align: center; padding: 60px 0; color: #999;">
                        暂无发票数据，点击右上角「批量导入」添加发票
                    </div>
                `;
                return;
            }
            
            let html = '';
            invoiceList.forEach(item => {
                html += `
                    <div class="invoice-item ${item.used ? 'used' : ''}" data-id="${item.id}">
                        <input type="checkbox" class="invoice-checkbox" ${item.checked ? 'checked' : ''}>
                        <div class="invoice-info">
                            <div class="invoice-date">${item.invoiceDate}</div>
                            <div class="invoice-buyer">购买方：${item.buyerName}</div>
                            <div class="invoice-amount">¥${item.amount}</div>
                            <div class="invoice-meta">
                                <span>编号：${item.invoiceNo}</span>
                                ${item.used ? '<span class="invoice-tag">已用</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            invoiceListDom.innerHTML = html;
            
            document.querySelectorAll('.invoice-checkbox').forEach((checkbox, index) => {
                checkbox.addEventListener('change', (e) => {
                    invoiceList[index].checked = e.target.checked;
                });
            });
        }

        // 更新额度显示
        function updateQuota() {
            const used = invoiceList.length;
            quotaText.innerText = `导入额度：${used}/${MAX_QUOTA}`;
            importBtn.disabled = used >= MAX_QUOTA;
        }

        // 全选/取消全选功能
        function handleSelectAll() {
            if (invoiceList.length === 0) {
                alert('暂无发票数据，无法全选');
                return;
            }
            const isAllSelected = invoiceList.every(item => item.checked);
            invoiceList.forEach(item => {
                item.checked = !isAllSelected;
            });
            renderInvoiceList();
        }

        // 删除选中发票功能
        function handleDelete() {
            const selectedList = invoiceList.filter(item => item.checked);
            if (selectedList.length === 0) {
                alert('请先选择要删除的发票');
                return;
            }
            if (!confirm(`确定要删除选中的${selectedList.length}张发票吗？删除后无法恢复`)) return;
            
            invoiceList = invoiceList.filter(item => !item.checked);
            saveToLocal();
            renderInvoiceList();
            updateQuota();
        }

        // 标记已用/未用功能
        function handleMarkUsed() {
            const selectedList = invoiceList.filter(item => item.checked);
            if (selectedList.length === 0) {
                alert('请先选择要标记的发票');
                return;
            }
            const isAllUsed = selectedList.every(item => item.used);
            const actionText = isAllUsed ? '标记为未用' : '标记为已用';
            if (!confirm(`确定要将选中的${selectedList.length}张发票${actionText}吗？`)) return;
            
            selectedList.forEach(item => {
                item.used = !isAllUsed;
            });
            saveToLocal();
            renderInvoiceList();
        }

        // 导出备份功能
        function handleExport() {
            if (invoiceList.length === 0) {
                alert('暂无发票数据可导出');
                return;
            }
            const dataStr = JSON.stringify(invoiceList, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `票理通发票备份_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 本地存储工具函数
        function saveToLocal() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(invoiceList));
        }

        // 加载提示工具函数
        function showLoading(text) {
            loadingText.innerText = text;
            loadingMask.classList.add('show');
        }
        function hideLoading() {
            loadingMask.classList.remove('show');
        }
    </script>
</body>
</html>
